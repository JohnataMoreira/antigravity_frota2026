// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  DRIVER
}

enum VehicleType {
  CAR
  TRUCK
  MOTORCYCLE
  MACHINE
}

enum VehicleStatus {
  AVAILABLE
  IN_USE
  MAINTENANCE
  CRITICAL_ISSUE
}

enum JourneyStatus {
  IN_PROGRESS
  COMPLETED
  CANCELED
}

enum ChecklistType {
  CHECKOUT
  CHECKIN
}

enum MaintenanceType {
  OIL
  TIRES
  INSPECTION
  OTHER
}

enum MaintenanceStatus {
  PENDING
  COMPLETED
  CANCELED
}

enum FuelType {
  GASOLINE
  ETHANOL
  DIESEL
  GNV
  OTHER
}

enum PaymentMethod {
  CASH
  DEBIT_CARD
  CREDIT_CARD
  PIX
  FUEL_CARD
  INVOICED
  REIMBURSEMENT
  PREPAID_CARD
  VOUCHER
  INTERNAL_TANK
}

model Organization {
  id        String   @id @default(uuid())
  name      String
  document  String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users     User[]
  vehicles  Vehicle[]
  journeys  Journey[]
  maintenances Maintenance[]
  fuelEntries FuelEntry[]
  incidents Incident[]
  maintenanceTemplates MaintenanceTemplate[]
  inventoryItems InventoryItem[]
  auditLogs AuditLog[]
  geofences Geofence[]
}

model AuditLog {
  id             String       @id @default(uuid())
  organizationId String
  userId         String?
  action         String       // CREATE, UPDATE, DELETE, LOGIN, etc.
  entity         String       // Vehicle, Journey, User, etc.
  entityId       String?      // The ID of the affected record
  
  // Stored as JSON: { oldValues: any, newValues: any, ip: string, userAgent: string }
  metadata       Json?
  
  createdAt      DateTime     @default(now())

  organization   Organization @relation(fields: [organizationId], references: [id])
}

model User {
  id             String       @id @default(uuid())
  organizationId String
  email          String       @unique
  passwordHash   String
  role           Role         @default(DRIVER)
  name           String
  firstName      String?
  lastName       String?
  phone          String?
  cpf            String?      @unique
  birthDate      DateTime?
  entryDate      DateTime?
  
  // Address fields
  addressStreet       String?
  addressNumber       String?
  addressComplement   String?
  addressNeighborhood String?
  addressCity         String?
  addressState        String?
  addressZipCode      String?

  licenseNumber  String?
  pushToken      String?      // Token for Expo/FCM push notifications
  active         Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id])
  journeys       Journey[]    @relation("DriverJourneys")
  fuelEntries    FuelEntry[]
  incidents      Incident[]
}

model Vehicle {
  id             String        @id @default(uuid())
  organizationId String
  plate          String
  model          String
  brand          String?
  year           Int?
  type           VehicleType
  currentKm      Int
  status         VehicleStatus @default(AVAILABLE)
  fuelLevel      Float         @default(100)
  photoUrl       String?
  lastMaintenanceKm   Int?
  lastMaintenanceDate DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  organization   Organization  @relation(fields: [organizationId], references: [id])
  journeys       Journey[]
  maintenances   Maintenance[]
  fuelEntries    FuelEntry[]
  incidents      Incident[]
  telemetryRecords TelemetryRecord[]

  @@unique([organizationId, plate])
}

model Journey {
  id             String        @id @default(uuid())
  organizationId String
  driverId       String
  vehicleId      String
  status         JourneyStatus @default(IN_PROGRESS)
  
  startKm        Int
  endKm          Int?
  
  startTime      DateTime      @default(now())
  endTime        DateTime?
  
  // Stored as JSON: { lat: number, lng: number, address?: string }
  startLocation  Json?
  endLocation    Json?

  // Route Optimization (v2.7)
  plannedRoute     Json?     // Array of lat/lng: [[lat, lng], ...]
  allowedDeviation Float     @default(500) // in meters
  isDeviated       Boolean   @default(false)
  destinationName  String?

  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  organization   Organization  @relation(fields: [organizationId], references: [id])
  driver         User          @relation("DriverJourneys", fields: [driverId], references: [id])
  vehicle        Vehicle       @relation(fields: [vehicleId], references: [id])
  checklists     Checklist[]
  fuelEntries    FuelEntry[]
  incidents      Incident[]
}

model Geofence {
  id             String   @id @default(uuid())
  organizationId String
  name           String
  type           String   // CIRCLE, POLYGON
  coordinates    Json     // CIRCLE: { center: [lat, lng], radius: number }, POLYGON: [[lat, lng], ...]
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id])
}

model Checklist {
  id        String        @id @default(uuid())
  journeyId String
  type      ChecklistType
  
  // Stored as JSON array: [{ itemId: string, status: "OK" | "ISSUE", notes?: string, photoUrl?: string }]
  items     Json

  // New field for Scorecard
  rating         Int?         // 1 to 5 stars (Quality of inspection)
  
  createdAt DateTime      @default(now())

  journey   Journey       @relation(fields: [journeyId], references: [id])
}

model Maintenance {
  id             String            @id @default(uuid())
  organizationId String
  vehicleId      String

  type           MaintenanceType
  lastKm         Int               @default(0)
  nextDueKm      Int

  status         MaintenanceStatus @default(PENDING)
  performedAt    DateTime?
  
  notes          String?
  cost           Float?

  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  organization   Organization      @relation(fields: [organizationId], references: [id])
  vehicle        Vehicle           @relation(fields: [vehicleId], references: [id])
}

model FuelEntry {
  id             String       @id @default(uuid())
  organizationId String
  vehicleId      String
  driverId       String
  journeyId      String?
  
  date           DateTime     @default(now())
  km             Int
  liters         Float
  totalValue     Float
  pricePerLiter  Float
  fuelType       FuelType     @default(GASOLINE)
  
  paymentMethod  PaymentMethod @default(CASH)
  paymentProvider String?     // Ex: Ticket Log, Ipiranga Max Frota
  paymentReference String?    // Ultimos digitos do cartão ou número da fatura
  
  photoUrl       String?      // Foto da nota fiscal
  notes          String?
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id])
  vehicle        Vehicle      @relation(fields: [vehicleId], references: [id])
  driver         User         @relation(fields: [driverId], references: [id])
  journey        Journey?     @relation(fields: [journeyId], references: [id])
}
model Incident {
  id             String       @id @default(uuid())
  organizationId String
  journeyId      String?
  driverId       String
  vehicleId      String

  description    String
  severity       String       @default("MEDIUM") // LOW, MEDIUM, HIGH
  status         String       @default("OPEN")   // OPEN, RESOLVED
  photoUrl       String?
  location       Json?        // { lat: number, lng: number }
  
  // New field for Scorecard
  isDriverAtFault Boolean     @default(false)

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id])
  journey        Journey?     @relation(fields: [journeyId], references: [id])
  driver         User         @relation(fields: [driverId], references: [id])
  vehicle        Vehicle      @relation(fields: [vehicleId], references: [id])
}

model MaintenanceTemplate {
  id             String       @id @default(uuid())
  organizationId String
  name           String
  description    String?
  type           String       // PREVENTIVE, CORRECTIVE
  vehicleTypes   VehicleType[]
  intervalKm     Int          @default(10000)
  averageDurationDays Int     @default(1)
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id])
}

model InventoryItem {
  id             String       @id @default(uuid())
  organizationId String
  name           String
  sku            String?
  category       String       // Filtros, Pneus, Lubrificantes, etc.
  unit           String       @default("UN") // UN, L, KG
  minQuantity    Float        @default(0)
  currentQuantity Float       @default(0)
  price          Float?       // Último preço de compra
  
  movements      StockMovement[]
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id])
}

model StockMovement {
  id             String       @id @default(uuid())
  inventoryItemId String
  type           String       // IN, OUT
  quantity       Float
  reason         String       // PURCHASE, MAINTENANCE, ADJUSTMENT
  notes          String?
  maintenanceId  String?
  
  createdAt      DateTime     @default(now())

  item           InventoryItem @relation(fields: [inventoryItemId], references: [id])
}

model TelemetryRecord {
  id             String   @id @default(uuid())
  vehicleId      String
  
  // Dados OBD / GPS
  timestamp      DateTime @default(now())
  latitude       Float?
  longitude      Float?
  speed          Float?
  odometer       Float?   // KM total
  fuelLevel      Float?   // Percentual (0-100)
  rpm            Int?
  voltage        Float?
  engineStatus   Boolean  @default(false) // ON/OFF
  
  vehicle        Vehicle  @relation(fields: [vehicleId], references: [id])
}

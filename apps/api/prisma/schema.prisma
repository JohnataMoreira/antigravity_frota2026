// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  DRIVER
}

enum VehicleType {
  CAR
  TRUCK
  MOTORCYCLE
  MACHINE
}

enum VehicleStatus {
  AVAILABLE
  IN_USE
  MAINTENANCE
  CRITICAL_ISSUE
}

enum JourneyStatus {
  IN_PROGRESS
  COMPLETED
  CANCELED
}

enum ChecklistType {
  CHECKOUT
  CHECKIN
}

enum MaintenanceType {
  OIL
  TIRES
  INSPECTION
  OTHER
}

enum MaintenanceStatus {
  PENDING
  COMPLETED
  CANCELED
}

enum FuelType {
  GASOLINE
  ETHANOL
  DIESEL
  GNV
  OTHER
}

enum PaymentMethod {
  CASH
  DEBIT_CARD
  CREDIT_CARD
  PIX
  FUEL_CARD
  INVOICED
  REIMBURSEMENT
  PREPAID_CARD
  VOUCHER
  INTERNAL_TANK
}

model Organization {
  id        String   @id @default(uuid())
  name      String
  document  String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users     User[]
  vehicles  Vehicle[]
  journeys  Journey[]
  maintenances Maintenance[]
  fuelEntries FuelEntry[]
}

model User {
  id             String       @id @default(uuid())
  organizationId String
  email          String       @unique
  passwordHash   String
  role           Role         @default(DRIVER)
  name           String
  firstName      String?
  lastName       String?
  phone          String?
  cpf            String?      @unique
  birthDate      DateTime?
  entryDate      DateTime?
  
  // Address fields
  addressStreet       String?
  addressNumber       String?
  addressComplement   String?
  addressNeighborhood String?
  addressCity         String?
  addressState        String?
  addressZipCode      String?

  licenseNumber  String?
  active         Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id])
  journeys       Journey[]    @relation("DriverJourneys")
  fuelEntries    FuelEntry[]
}

model Vehicle {
  id             String        @id @default(uuid())
  organizationId String
  plate          String
  model          String
  brand          String?
  year           Int?
  type           VehicleType
  currentKm      Int
  status         VehicleStatus @default(AVAILABLE)
  photoUrl       String?
  lastMaintenanceKm   Int?
  lastMaintenanceDate DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  organization   Organization  @relation(fields: [organizationId], references: [id])
  journeys       Journey[]
  maintenances   Maintenance[]
  fuelEntries    FuelEntry[]

  @@unique([organizationId, plate])
}

model Journey {
  id             String        @id @default(uuid())
  organizationId String
  driverId       String
  vehicleId      String
  status         JourneyStatus @default(IN_PROGRESS)
  
  startKm        Int
  endKm          Int?
  
  startTime      DateTime      @default(now())
  endTime        DateTime?
  
  // Stored as JSON: { lat: number, lng: number, address?: string }
  startLocation  Json?
  endLocation    Json?

  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  organization   Organization  @relation(fields: [organizationId], references: [id])
  driver         User          @relation("DriverJourneys", fields: [driverId], references: [id])
  vehicle        Vehicle       @relation(fields: [vehicleId], references: [id])
  checklists     Checklist[]
  fuelEntries    FuelEntry[]
}

model Checklist {
  id        String        @id @default(uuid())
  journeyId String
  type      ChecklistType
  
  // Stored as JSON array: [{ itemId: string, status: "OK" | "ISSUE", notes?: string, photoUrl?: string }]
  items     Json
  
  createdAt DateTime      @default(now())

  journey   Journey       @relation(fields: [journeyId], references: [id])
}

model Maintenance {
  id             String            @id @default(uuid())
  organizationId String
  vehicleId      String

  type           MaintenanceType
  lastKm         Int               @default(0)
  nextDueKm      Int

  status         MaintenanceStatus @default(PENDING)
  performedAt    DateTime?
  
  notes          String?
  cost           Float?

  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  organization   Organization      @relation(fields: [organizationId], references: [id])
  vehicle        Vehicle           @relation(fields: [vehicleId], references: [id])
}

model FuelEntry {
  id             String       @id @default(uuid())
  organizationId String
  vehicleId      String
  driverId       String
  journeyId      String?
  
  date           DateTime     @default(now())
  km             Int
  liters         Float
  totalValue     Float
  pricePerLiter  Float
  fuelType       FuelType     @default(GASOLINE)
  
  paymentMethod  PaymentMethod @default(CASH)
  paymentProvider String?     // Ex: Ticket Log, Ipiranga Max Frota
  paymentReference String?    // Ultimos digitos do cartão ou número da fatura
  
  photoUrl       String?      // Foto da nota fiscal
  notes          String?
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id])
  vehicle        Vehicle      @relation(fields: [vehicleId], references: [id])
  driver         User         @relation(fields: [driverId], references: [id])
  journey        Journey?     @relation(fields: [journeyId], references: [id])
}

